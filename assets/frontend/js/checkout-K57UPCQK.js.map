{
  "version": 3,
  "sources": ["../src/wc/checkout.ts"],
  "sourcesContent": ["import type Udesly from \"../utils/udesly\";\nimport type {WooCommerceRootModel} from \"../store/wc-models\";\nimport Eta from '../utils/eta';\nimport {onJQueryEvent, triggerJQuery} from \"../utils/triggers\";\n\nEta.config.autoEscape = false;\n\n\nexport default class Checkout {\n    private templateFunction: any;\n    private itemsList?: Element;\n    private includeTaxes: boolean;\n\n    constructor(private udesly: Udesly<WooCommerceRootModel>, private checkoutWrapper: HTMLElement) {\n\n        wc_checkout_params.wc_ajax_url+=\"&udesly_checkout=true\"\n        wc_checkout_params.checkout_url+=\"&udesly_checkout=true\"\n        wc_checkout_params.is_checkout = \"1\";\n\n        jQuery.scroll_to_notices =  () => {\n            const errorState = this.checkoutWrapper.querySelector('[data-node-type=\"commerce-checkout-error-state\"]');\n            if (errorState) {\n                errorState.scrollIntoView({block: \"center\", behavior: \"smooth\"})\n            }\n        }\n        this.includeTaxes = window.udesly_frontend_options.wc.show_taxes === \"incl\";\n        this.handleItemsInOrder(this.checkoutWrapper.querySelector(\".w-commerce-commercecheckoutblockcontent\"));\n\n        this.handleCoupon();\n\n        this.initDOMEvents();\n\n        this.initStoreEvents();\n    }\n\n    initDOMEvents() {\n        this.checkoutWrapper.querySelectorAll('[data-node-type=\"commerce-checkout-place-order-button\"]').forEach(el => {\n            el.addEventListener('click', e => {\n                this.checkoutWrapper.dispatchEvent(new Event('submit', {bubbles: true}))\n            })\n        })\n        this.checkoutWrapper.addEventListener('change', () => {\n            this.hideErrorState();\n        })\n    }\n\n    initStoreEvents() {\n\n        onJQueryEvent('update_checkout', () => {\n            this.udesly.dispatch('woocommerce/updateCheckout');\n        })\n\n        this.udesly.on('woocommerce/checkoutNotice', (errors) => {\n            this.checkoutWrapper.querySelectorAll('.woocommerce-NoticeGroup-checkout').forEach(el => el.remove());\n            const errorState = this.checkoutWrapper.querySelector('[data-node-type=\"commerce-checkout-error-state\"]');\n\n            if (errorState) {\n                errorState.outerHTML = errors;\n               errorState.scrollIntoView({block: \"center\", behavior: \"smooth\"})\n            }\n        })\n    }\n\n    hideErrorState() {\n        const errorState = this.checkoutWrapper.querySelector<HTMLElement>('[data-node-type=\"commerce-checkout-error-state\"]');\n\n        if (errorState) {\n            errorState.style.display = \"none\";\n        }\n    }\n\n    handleCoupon() {\n        const couponForm = this.checkoutWrapper.querySelector('[data-node-type=\"commerce-checkout-discount-form\"]');\n        if (!couponForm) {\n            return;\n        }\n        const realCouponForm = document.querySelector('form#coupon_form');\n        if (!realCouponForm) {\n            return;\n        }\n\n        if (realCouponForm) {\n           realCouponForm.addEventListener('submit', e => {\n               this.hideErrorState();\n               e.preventDefault();\n               e.stopPropagation();\n               e.stopImmediatePropagation();\n               this.udesly.dispatch(\"woocommerce/applyCoupon\", {\n                   coupon_code: couponForm.querySelector('input[name=coupon_code]').value\n               });\n           }, true);\n        }\n    }\n\n    handleItemsInOrder(wrapper: HTMLElement) {\n        if(!wrapper) {\n            return;\n        }\n        const template = wrapper.querySelector('script[type=\"text/x-wf-template\"]').textContent;\n\n        this.templateFunction = Eta.compile(template);\n        \n        this.itemsList = wrapper.querySelector('.w-commerce-commercecheckoutorderitemslist');\n\n        this.udesly.on(\"woocommerce/cartChanged\", () => {\n            this.refreshItemsInOrder()\n        });\n        this.refreshItemsInOrder();\n    }\n\n    refreshItemsInOrder() {\n        const {count, items, subtotal, total} = this.udesly.getState().woocommerce;\n        if (!count) {\n            window.location = window.udesly_frontend_options.wc.cart_url;\n        }\n        this.refreshItems(items);\n    }\n\n    refreshItems(items: any[]) {\n        if (!this.itemsList) {\n            return;\n        }\n        this.itemsList.innerHTML = items.reduce((prev, next) => {\n            next.rowTotal = this.includeTaxes ? next.total : next.subtotal;\n            return prev+= Eta.render(this.templateFunction, next);\n        }, \"\");\n    }\n}"],
  "mappings": ";;;;;;;;;;;AAEA,iBAAgB;AAGhB,mBAAI,OAAO,aAAa;AAGxB,qBAA8B;AAAA,EAK1B,YAAoB,QAA8C,iBAA8B;AAA5E;AAA8C;AAE9D,uBAAmB,eAAa;AAChC,uBAAmB,gBAAc;AACjC,uBAAmB,cAAc;AAEjC,WAAO,oBAAqB,MAAM;AAC9B,YAAM,aAAa,KAAK,gBAAgB,cAAc;AACtD,UAAI,YAAY;AACZ,mBAAW,eAAe,CAAC,OAAO,UAAU,UAAU;AAAA;AAAA;AAG9D,SAAK,eAAe,OAAO,wBAAwB,GAAG,eAAe;AACrE,SAAK,mBAAmB,KAAK,gBAAgB,cAAc;AAE3D,SAAK;AAEL,SAAK;AAEL,SAAK;AAAA;AAAA,EAGT,gBAAgB;AACZ,SAAK,gBAAgB,iBAAiB,2DAA2D,QAAQ,QAAM;AAC3G,SAAG,iBAAiB,SAAS,OAAK;AAC9B,aAAK,gBAAgB,cAAc,IAAI,MAAM,UAAU,CAAC,SAAS;AAAA;AAAA;AAGzE,SAAK,gBAAgB,iBAAiB,UAAU,MAAM;AAClD,WAAK;AAAA;AAAA;AAAA,EAIb,kBAAkB;AAEd,kBAAc,mBAAmB,MAAM;AACnC,WAAK,OAAO,SAAS;AAAA;AAGzB,SAAK,OAAO,GAAG,8BAA8B,CAAC,WAAW;AACrD,WAAK,gBAAgB,iBAAiB,qCAAqC,QAAQ,QAAM,GAAG;AAC5F,YAAM,aAAa,KAAK,gBAAgB,cAAc;AAEtD,UAAI,YAAY;AACZ,mBAAW,YAAY;AACxB,mBAAW,eAAe,CAAC,OAAO,UAAU,UAAU;AAAA;AAAA;AAAA;AAAA,EAKjE,iBAAiB;AACb,UAAM,aAAa,KAAK,gBAAgB,cAA2B;AAEnE,QAAI,YAAY;AACZ,iBAAW,MAAM,UAAU;AAAA;AAAA;AAAA,EAInC,eAAe;AACX,UAAM,aAAa,KAAK,gBAAgB,cAAc;AACtD,QAAI,CAAC,YAAY;AACb;AAAA;AAEJ,UAAM,iBAAiB,SAAS,cAAc;AAC9C,QAAI,CAAC,gBAAgB;AACjB;AAAA;AAGJ,QAAI,gBAAgB;AACjB,qBAAe,iBAAiB,UAAU,OAAK;AAC3C,aAAK;AACL,UAAE;AACF,UAAE;AACF,UAAE;AACF,aAAK,OAAO,SAAS,2BAA2B;AAAA,UAC5C,aAAa,WAAW,cAAc,2BAA2B;AAAA;AAAA,SAEtE;AAAA;AAAA;AAAA,EAIV,mBAAmB,SAAsB;AACrC,QAAG,CAAC,SAAS;AACT;AAAA;AAEJ,UAAM,WAAW,QAAQ,cAAc,qCAAqC;AAE5E,SAAK,mBAAmB,mBAAI,QAAQ;AAEpC,SAAK,YAAY,QAAQ,cAAc;AAEvC,SAAK,OAAO,GAAG,2BAA2B,MAAM;AAC5C,WAAK;AAAA;AAET,SAAK;AAAA;AAAA,EAGT,sBAAsB;AAClB,UAAM,CAAC,OAAO,OAAO,UAAU,SAAS,KAAK,OAAO,WAAW;AAC/D,QAAI,CAAC,OAAO;AACR,aAAO,WAAW,OAAO,wBAAwB,GAAG;AAAA;AAExD,SAAK,aAAa;AAAA;AAAA,EAGtB,aAAa,OAAc;AACvB,QAAI,CAAC,KAAK,WAAW;AACjB;AAAA;AAEJ,SAAK,UAAU,YAAY,MAAM,OAAO,CAAC,MAAM,SAAS;AACpD,WAAK,WAAW,KAAK,eAAe,KAAK,QAAQ,KAAK;AACtD,aAAO,QAAO,mBAAI,OAAO,KAAK,kBAAkB;AAAA,OACjD;AAAA;AAAA;AArHX,IAAO,mBAAP;",
  "names": []
}
