{
  "version": 3,
  "sources": ["../src/wc/mini-cart.ts"],
  "sourcesContent": ["import type Udesly from \"../utils/udesly\";\nimport type {WooCommerceRootModel} from \"../store/wc-models\";\nimport {getElementByDataNodeType, getElementsByDataNodeType, handleChangeCartStateEvent} from \"../utils/webflow\";\nimport Eta from '../utils/eta';\n\nEta.config.autoEscape = false;\n\nexport default class MiniCart {\n\n    templateFunction = Function;\n    private readonly openOnProductAdded: boolean;\n    private readonly openOnHover: boolean;\n    private emptyState: HTMLElement;\n    private itemsState: HTMLElement;\n    private includeTaxes: boolean;\n    private itemsList: Element;\n\n    constructor(private udesly: Udesly<WooCommerceRootModel>, private wrapper: HTMLElement) {\n\n       const template = wrapper.querySelector('script[type=\"text/x-wf-template\"]').textContent;\n\n       this.templateFunction = Eta.compile(template);\n\n        this.openOnProductAdded = this.wrapper.hasAttribute('data-open-product');\n        this.openOnHover = this.wrapper.hasAttribute('data-open-on-hover');\n\n        this.emptyState = this.wrapper.querySelector('.w-commerce-commercecartemptystate');\n        this.itemsState = this.wrapper.querySelector('.w-commerce-commercecartform');\n        this.itemsList = this.wrapper.querySelector('.w-commerce-commercecartlist');\n\n        this.initDomEvents();\n\n        this.includeTaxes = window.udesly_frontend_options.wc.show_taxes === \"incl\";\n\n        this.initStoreEvents();\n\n    }\n\n    initStoreEvents() {\n        this.udesly.on(\"woocommerce/toggleCart\", () => {\n            if (window.getComputedStyle(this.wrapper).display == \"none\") {\n                return;\n            }\n            this.wrapper.dispatchEvent(new CustomEvent(\"wf-change-cart-state\", {\n                detail: {\n                    open: this.udesly.getState().woocommerce.cartOpen\n                }\n            }))\n        })\n\n        this.udesly.on(\"woocommerce/cartChanged\", () => {\n            this.refreshCart()\n        });\n\n        if (this.openOnProductAdded) {\n            this.udesly.on(\"woocommerce/addedToCart\", () => {\n               this.udesly.dispatch(\"woocommerce/toggleCart\");\n            });\n        }\n\n        this.refreshCart();\n    }\n\n    updateCartCount(itemsCount) {\n\n       this.wrapper.querySelectorAll('.w-commerce-commercecartopenlinkcount').forEach(cartCount => {\n            cartCount.textContent = itemsCount;\n        })\n\n        this.wrapper.querySelectorAll('[data-count-hide-rule]').forEach(cartCount => {\n            if (cartCount.getAttribute('data-count-hide-rule') === \"empty\") {\n                if (itemsCount === 0) {\n                    cartCount.style.display = \"none\"\n                } else {\n                    cartCount.style.display = \"block\";\n                }\n            }\n        })\n    }\n\n    refreshCart() {\n        this.wrapper.querySelectorAll('.udy-loading').forEach(el => el.classList.remove('udy-loading'));\n        const {count, items, subtotal, total} = this.udesly.getState().woocommerce;\n\n        this.updateCartCount(count);\n\n        this.refreshTotal(this.includeTaxes ? total : subtotal);\n\n        if (items.length) {\n            this.refreshItems(items);\n            this.emptyState.style.display = \"none\";\n            this.itemsState.style.display = \"\";\n        } else {\n            this.emptyState.style.display = \"\";\n            this.itemsState.style.display = \"none\";\n        }\n    }\n\n    refreshItems(items: any[]) {\n        this.itemsList.innerHTML = items.reduce((prev, next) => {\n            next.rowTotal = this.includeTaxes ? next.total : next.subtotal;\n            return prev+= Eta.render(this.templateFunction, next);\n        }, \"\");\n    }\n\n    refreshTotal(total) {\n        this.wrapper.querySelectorAll('.w-commerce-commercecartordervalue').forEach( order => {\n            order.innerHTML = total;\n        })\n    }\n\n    initDomEvents() {\n\n        this.wrapper.addEventListener('wf-change-cart-state', (e : CustomEvent) => handleChangeCartStateEvent(e, this.wrapper));\n        getElementsByDataNodeType(\"commerce-cart-open-link\", this.wrapper).forEach(openLink => {\n            openLink.addEventListener(\"click\", () => {\n                this.udesly.dispatch(\"woocommerce/toggleCart\")\n            }, true)\n            if (this.openOnHover) {\n                openLink.addEventListener(\"mouseenter\", () => {\n                    this.udesly.dispatch(\"woocommerce/toggleCart\")\n                }, true)\n                const container = getElementByDataNodeType('commerce-cart-container', this.wrapper);\n                if (container) {\n                    container.addEventListener(\"mouseleave\", () => {\n                        this.udesly.dispatch(\"woocommerce/toggleCart\")\n                    })\n                }\n            }\n        });\n\n        this.wrapper.addEventListener('submit', e => {\n            e.preventDefault();\n        })\n\n        this.wrapper.addEventListener('change', e => {\n            if (e.target.matches('.w-commerce-commercecartquantity')) {\n                const target = e.target;\n                e.target.closest('.w-commerce-commercecartitem')?.classList.add('udy-loading');\n                this.wrapper.querySelector('.w-commerce-commercecartordervalue')?.classList.add('udy-loading');\n                this.udesly.dispatch(\"woocommerce/updateCartQuantity\", {\n                    key: target.name,\n                    quantity: target.value,\n                })\n                e.preventDefault();\n            }\n        })\n\n        getElementsByDataNodeType(\"commerce-cart-close-link\", this.wrapper).forEach(closeLink => {\n            closeLink.addEventListener(\"click\", () => {\n                this.udesly.dispatch(\"woocommerce/toggleCart\")\n            }, true)\n        });\n\n        getElementsByDataNodeType(\"commerce-cart-container-wrapper\", this.wrapper).forEach(w => {\n            w.addEventListener(\"click\", e => {\n                if (!e.target.matches(`[data-node-type=\"commerce-cart-container\"], [data-node-type=\"commerce-cart-container\"] *`)) {\n                    this.udesly.dispatch(\"woocommerce/toggleCart\")\n                }\n                if (e.target.matches(`[data-node-type=\"cart-remove-link\"]`)) {\n                    e.target.closest('.w-commerce-commercecartitem')?.classList.add('udy-loading');\n                    this.wrapper.querySelector('.w-commerce-commercecartordervalue')?.classList.add('udy-loading');\n                    this.udesly.dispatch(\"woocommerce/removeFromCart\", e.target.getAttribute('key'))\n                    e.preventDefault();\n                }\n            }, true)\n        });\n\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
